# SSH подключение к принтеру с Klipper на Armbian

## Введение

SSH (Secure Shell) — это протокол для безопасного удалённого управления устройствами через сеть. В контексте 3D-печати SSH используется для управления одноплатными компьютерами (Orange Pi, Raspberry Pi и др.) с установленным Armbian, на которых работает прошивка Klipper.

## Что такое SSH в контексте 3D-принтера

SSH позволяет:
- Удалённо управлять компьютером принтера из командной строки
- Редактировать конфигурационные файлы Klipper
- Устанавливать и обновлять программное обеспечение
- Диагностировать проблемы системы
- Передавать файлы между компьютером и принтером

## Подготовка к подключению

### Требования
- Одноплатный компьютер с установленным Armbian
- Klipper, установленный на компьютере
- Сетевое подключение (Wi-Fi или Ethernet)
- SSH-клиент на вашем компьютере

### Получение IP-адреса принтера
**Способ 1: С меню принтера**
1. Шестеренка
2. Сеть
   <img src="/docs/images/network-screen.jpg" width="300">

**Способ 2: Через веб-интерфейс Mainsail/Fluidd**
1. Откройте веб-интерфейс принтера
2. Перейдите в раздел "System" или "Система"
3. Найдите информацию о сети и запишите IP-адрес

**Способ 3: Через роутер**
1. Зайдите в админ-панель роутера (обычно 192.168.1.1 или 192.168.0.1)
2. Найдите список подключённых устройств
3. Найдите ваш принтер по имени или MAC-адресу

**Способ 3: Сканирование сети**
```bash
# На Linux/macOS
nmap -sn 192.168.1.0/24

# На Windows (если установлен nmap)
nmap -sn 192.168.1.0/24
```

## Подключение по SSH

### Windows

**Использование встроенного SSH-клиента (Windows 10/11):**
1. Откройте командную строку (cmd) или PowerShell
2. Выполните команду:
```cmd
ssh mks@192.168.1.100
```
Где `192.168.1.100` — IP-адрес вашего принтера

**Альтернативные SSH-клиенты:**
- **PuTTY** - популярный SSH-клиент: https://www.putty.org/
- **MobaXterm** - многофункциональный терминал с SSH: https://mobaxterm.mobatek.net/

### macOS и Linux

Откройте терминал и выполните:
```bash
ssh mks@192.168.1.100
```

### Первое подключение

При первом подключении появится предупреждение о неизвестном хосте:
```
The authenticity of host '192.168.1.100 (192.168.1.100)' can't be established.
ECDSA key fingerprint is SHA256:...
Are you sure you want to continue connecting (yes/no/[fingerprint])?
```

Введите `yes` и нажмите Enter.

### Авторизация

**Стандартные учётные данные для принтеров QIDI с платой MKS:**
- Пользователь: `mks`
- Пароль: `makerbase`

**Для других образов с предустановленным Klipper:**
- Пользователь: `pi` или `klipper`
- Пароль: обычно указан в документации образа

**Важно:** При вводе пароля символы не отображаются на экране - это нормальное поведение SSH для безопасности. Просто введите пароль и нажмите Enter.

## ⚠️ Важные предупреждения для принтеров QIDI

**НЕ ОБНОВЛЯЙТЕ СИСТЕМУ ЧЕРЕЗ APT!** Принтеры QIDI используют модифицированную версию Klipper и специально настроенную систему. Выполнение команд `apt update` и `apt upgrade` может сломать систему принтера. Все обновления должны производиться только через официальное ПО QIDI.

## Основные команды для управления Klipper

### Навигация по файловой системе
```bash
# Перейти в домашнюю директорию
cd ~

# Перейти в директорию конфигурации Klipper
cd ~/printer_data/config

# Просмотр содержимого директории
ls -la

# Просмотр текущего местоположения
pwd
```

### Управление файлами конфигурации
```bash
# Редактирование главного конфига Klipper
nano ~/printer_data/config/printer.cfg

# Создание резервной копии конфига
cp ~/printer_data/config/printer.cfg ~/printer_data/config/printer.cfg.backup

# Просмотр логов Klipper
tail -f ~/printer_data/logs/klippy.log
```

### Управление службами
```bash
# Перезапуск Klipper
sudo systemctl restart klipper

# Проверка статуса Klipper
sudo systemctl status klipper

# Перезапуск Moonraker
sudo systemctl restart moonraker

# Перезапуск веб-интерфейса (nginx)
sudo systemctl restart nginx
```

## Передача файлов

### SCP (Secure Copy)
```bash
# Копирование файла с компьютера на принтер
scp ~/Desktop/printer.cfg mks@192.168.1.100:~/printer_data/config/

# Копирование файла с принтера на компьютер
scp mks@192.168.1.100:~/printer_data/logs/klippy.log ~/Desktop/
```

### Использование SFTP
```bash
# Подключение по SFTP
sftp mks@192.168.1.100

# Команды в SFTP сессии:
# ls - список файлов на удалённом сервере
# lls - список файлов на локальном компьютере  
# get filename - скачать файл
# put filename - загрузить файл
# exit - выйти
```

## Безопасность
<details>
<summary>Если очень интересно</summary>

### Рекомендации по безопасности
1. Смените стандартный пароль пользователя
2. Используйте SSH-ключи вместо паролей
3. Отключите вход для пользователя root по SSH
4. Смените стандартный порт SSH (22) на другой
5. Настройте файрвол для ограничения доступа

### Изменение SSH-порта
```bash
# Редактирование конфигурации SSH
sudo nano /etc/ssh/sshd_config

# Найдите строку #Port 22 и измените на:
Port 2222

# Перезапустите SSH-сервис
sudo systemctl restart ssh
```

После этого подключение выполняется с указанием порта:
```bash
ssh -p 2222 mks@192.168.1.100
```

## Настройка SSH-ключей

Для удобства и безопасности рекомендуется настроить авторизацию по SSH-ключам:

### Генерация ключей
```bash
# На вашем компьютере
ssh-keygen -t rsa -b 4096 -C "your_email@example.com"
```

### Копирование публичного ключа на принтер
```bash
ssh-copy-id mks@192.168.1.100
```

После этого вы сможете подключаться без ввода пароля.
</details>


## Устранение типичных проблем

### Принтер не отвечает по SSH
1. Проверьте сетевое подключение: `ping 192.168.1.100`
2. Убедитесь, что SSH-сервис запущен на принтере
3. Проверьте правильность IP-адреса
4. Попробуйте подключиться к другому порту, если SSH настроен нестандартно

### Отказ в доступе
1. Проверьте правильность имени пользователя и пароля
2. Убедитесь, что SSH-сервис разрешает подключения для данного пользователя
3. Проверьте, не заблокирован ли ваш IP-адрес

### Соединение разрывается
1. Проверьте стабильность сетевого соединения
2. Настройте keep-alive параметры в SSH-клиенте
3. Увеличьте таймаут соединения

### Проблемы с правами доступа
```bash
# Изменение владельца файла
sudo chown mks:mks filename

# Изменение прав доступа
sudo chmod 755 filename

# Добавление пользователя в группу
sudo usermod -a -G dialout mks
```



## Полезные скрипты

### Автоматическое резервное копирование конфигурации
```bash
#!/bin/bash
# backup_config.sh
DATE=$(date +%Y%m%d_%H%M%S)
cp ~/printer_data/config/printer.cfg ~/printer_data/config/backups/printer_${DATE}.cfg
echo "Backup created: printer_${DATE}.cfg"
```

### Быстрая проверка статуса служб
```bash
#!/bin/bash
# check_services.sh
echo "=== Klipper Status ==="
sudo systemctl status klipper --no-pager -l
echo "=== Moonraker Status ==="
sudo systemctl status moonraker --no-pager -l
echo "=== Nginx Status ==="
sudo systemctl status nginx --no-pager -l
```

## Заключение

SSH является мощным инструментом для управления принтерами с Klipper на Armbian. Правильная настройка и использование SSH позволяет эффективно администрировать принтер, быстро решать проблемы и поддерживать систему в актуальном состоянии. Помните о важности соблюдения мер безопасности при работе с удалённым доступом.

---

Вот полный исправленный текст со всеми нужными правками:
- Креды изменены на `mks`/`makerbase`
- Упрощен раздел про SSH-клиенты
- Добавлено примечание о невидимом пароле
- Убран раздел обновления системы
- Добавлено предупреждение для QIDI
- Все команды обновлены с `mks@` вместо `pi@`
